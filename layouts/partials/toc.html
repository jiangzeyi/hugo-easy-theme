{{ $headers := findRE "<h[1-6].*?>(.|\n])+?</h[1-6]>" .Content }}
{{- $has_headers := ge (len $headers) 1 -}}
{{ $largest := 0}}
{{ if  $has_headers }}
    {{ range $headers }}
        {{ $header_level := index (findRE "[1-6]" . 1) 0 }}
        {{ if lt $header_level $largest }}
            {{ $largest := $header_level }}
        {{ end }}
    {{ end }}
{{ end }}

{{ $first_header_level := len (seq (index (findRE "[1-6]" (index $headers 0) 1) 0)) }}

{{ range $i, $header := $headers }}
    {{ $current_level := index (findRE "[1-6]" $header 1) 0}}
{{ end }}

{{ $data := newScratch }}
{{ $data.Set "bareul" slice }}

<ul>
    {{ range seq (sub $first_header_level $largest) }}
        <ul>
        {{ $data.Add "bareul" (sub (add $largest .) 1) }}
    {{ end }}
        {{ range $i, $header := $headers }}
        {{ $headerLevel := index (findRE "[1-6]" . 1) 0 }}
        {{ $headerLevel := len (seq $headerLevel) -}}
        {{ $id := index (findRE "(id=\"(.*?)\")" $header 9) 0 }}
        {{ $cleanedID := replace (replace $id "id=\"" "") "\"" "" }}
        {{ $header := replaceRE "<h[1-6].*?>((.|\n])+?)</h[1-6]>" "$1" $header }}
            {{ if ne $i 0 }}
                {{/*  获取上一个标题的等级  */}}
                {{ $prevHeaderLevel := index (findRE "[1-6]" (index $headers (sub $i 1)) 1) 0 }}
                {{ $prevHeaderLevel := len (seq $prevHeaderLevel) }}
                {{/*  当前标题等级 大于上个标题等级  */}}
                {{ if gt $headerLevel $prevHeaderLevel }}
                    {{ range seq $prevHeaderLevel (sub $headerLevel  1) }}
                        <ul>
                            {{ if ne $prevHeaderLevel . }}
                                {{ $data.Add "bareul" . }}
                            {{ end }}
                    {{ end }}
                {{ else }}
                        </li>
                    {{ if lt $headerLevel $prevHeaderLevel}}
                        {{ range seq (sub $prevHeaderLevel 1) -1 $headerLevel }}
                            {{ if in ($data.Get "bareul") . }}
                                </ul>
                                {{ $tmp := $data.Get "bareul" }}
                                {{ $data.Delete "bareul" }}
                                {{ $data.Set "bareul" slice }}
                                {{- range seq (sub (len $tmp) 1) -}}
                                    {{- $.Scratch.Add "bareul" (index $tmp (sub . 1)) -}}
                                {{- end -}}
                            {{ else }}
                            <ul>
                            </li>
                            {{ end }}
                        {{ end }}
                    {{ end }}
                {{ end }}
                <li>
                <a href="#{{- $cleanedID -}}" aria-label="{{- $header | plainify -}}">{{- $header | safeHTML -}}</a>
            {{ else }}  
                </li>
                <a href="#{{- $cleanedID -}}" aria-label="{{- $header | plainify -}}">{{- $header | safeHTML -}}</a>
            {{ end }}            
        {{end }}
        {{- $firstHeaderLevel := $largest }}
        {{- $lastHeaderLevel := len (seq (index (findRE "[1-6]" (index $headers (sub (len $headers) 1)) 1) 0)) }}
            </li>
        {{- range seq (sub $lastHeaderLevel $firstHeaderLevel) -}}
            {{- if in ($.Scratch.Get "bareul") (add . $firstHeaderLevel) }}
                </ul>
            {{ else }}
                </ul>
                </li>
            {{ end }}
        {{ end }}
    </ul>